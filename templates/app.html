
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Welcome, {{.Username}}!</h1>
            <button id="logout-btn">Logout</button>
            <button id="get-data-btn">Get Data</button>
        </header>
        
        <div class="contend-container">
            <p>Content comes here</p>

            <!-- Table placeholder -->
            <table id="booking-table" class="table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody id="booking-table-body">
                    <!-- Rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

  
<script>
    // Check if token exists in localStorage
    const token = localStorage.getItem('token');
    if (!token) {
        // Try to see if we have a session cookie already
        // If we're here without a localStorage token, we might still have a valid session
        fetch('/app', {
            method: 'GET',
            credentials: 'include'  // Include cookies
        }).then(response => {
            if (!response.ok) {
                // If the request fails, redirect to login
                window.location.href = '/login';
            }
            // If successful, we already have the page loaded
        }).catch(() => {
            window.location.href = '/login';
        });
    }
    
    // Set token in Authorization header for all fetch requests
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
        options = options || {};
        options.headers = options.headers || {};
        
        // Only add Authorization header if we have a token
        if (token) {
            options.headers['Authorization'] = `Bearer ${token}`;
        }
        
        return originalFetch(url, options);
    };
    
    // Setup WebSocket connection with appropriate authentication
    let socket;
    
    function connectWebSocket() {
        console.log("Connecting websocket")
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socketUrl = `${protocol}//${window.location.host}/ws`;
        
        // Create WebSocket with credentials
        socket = new WebSocket(socketUrl);
        
        // Send authentication immediately after connection
        socket.onopen = function() {
            console.log('WebSocket connection established');
            // Send authentication message
           /*  if (token) {
                socket.send(JSON.stringify({
                    type: 'auth',
                    token: token
                }));
            } */
        };
        
        // Rest of WebSocket code remains the same...
        socket.onmessage = function(event) {
            console.log("sending message to websocket")
            const response = JSON.parse(event.data);
            displayMessage(response);

            if (response.type === 'handleGetBookingsResponse' && !response.isError) {
                    displayBookings(response.message);
                }
        };
        
        socket.onclose = function() {
            console.log('WebSocket connection closed');
            // Try to reconnect after a delay
            setTimeout(connectWebSocket, 3000);
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }
    

    document.getElementById('logout-btn').addEventListener('click', function() {
    console.log("logout requested");

    // Remove token from localStorage
    localStorage.removeItem('token');

    // Send a request to the server to invalidate the session and delete the cookie
    fetch('/logout', {
        method: 'POST',
        credentials: 'include' // Ensure cookies are included in the request
    }).then(response => {
        if (response.ok) {
            // Redirect to login page after successful logout
            window.location.href = '/login';
        } else {
            console.error('Logout failed');
        }
    }).catch(error => {
        console.error('Logout error:', error);
    });
});
     // New "Get Data" button event handler
     document.getElementById('get-data-btn').addEventListener('click', function() {
            console.log("getData requested");

            // Ensure WebSocket is open before sending the message
            if (socket && socket.readyState === WebSocket.OPEN) {
                // Send request to WebSocket with specified JSON structure
                socket.send(JSON.stringify({
                    type: "getBookings",
                    content: "currentMonth"
                }));
            } else {
                console.error("WebSocket is not open");
            }
        });

        // Function to handle displaying messages (placeholder)
        function displayMessage(message) {
            console.log("Received message:", message);
            // Add logic here to handle WebSocket messages from the server
        }


          // Function to display bookings in a table
          function displayBookings(bookings) {
            const table = document.getElementById('booking-table');
            const tableBody = document.getElementById('booking-table-body');
            
            // Clear existing rows in case of multiple requests
            tableBody.innerHTML = '';

            // Loop through each booking and create a row
            bookings.forEach(booking => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${booking.id}</td>
                    <td>${booking.from}</td>
                    <td>${booking.to}</td>
                    <td>${booking.duration || 'N/A'}</td>
                `;

                tableBody.appendChild(row);
            });

            // Show the table
            table.style.display = 'table';
        }

    connectWebSocket();
</script>
</body>
</html>